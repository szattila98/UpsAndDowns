name: Tauri

on:
    push:
        branches: ['main']
    pull_request:
        branches: ['**']
        types: [opened, synchronize]
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always
    SQLX_OFFLINE: true

jobs:
    check:
        name: Build
        permissions:
            contents: write
        strategy:
            fail-fast: true
            matrix:
                platform: [macos-latest, ubuntu-latest, windows-latest]

        runs-on: ${{ matrix.platform }}
        steps:
            - uses: actions/checkout@v4

            - uses: Swatinem/rust-cache@v2
              with:
                  shared-key: whooosh-${{ matrix.platform }}
                  workspaces: src-tauri

            - uses: volta-cli/action@v4

            - uses: dtolnay/rust-toolchain@stable

            - if: matrix.platform == 'ubuntu-latest'
              run: |
                  sudo apt update
                  sudo apt install libwebkit2gtk-4.0-dev \
                      build-essential \
                      curl \
                      wget \
                      file \
                      libssl-dev \
                      libgtk-3-dev \
                      libayatana-appindicator3-dev \
                      librsvg2-dev

            - run: yarn install --immutable

            - run: yarn tauri build
